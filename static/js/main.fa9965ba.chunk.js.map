{"version":3,"sources":["utils/toast.js","utils/compressBase64.js","utils/getUserMediaStream.js","views/photo/photo.jsx","routes/routes.jsx","constants/constants.js","reducers/module/auth.js","reducers/reducers.js","store/store.js","App.js","index.js","views/photo/photo.module.scss"],"names":["__hide","Toast","hide","hideLoading","showLoading","text","loading","showFail","config","mask","duration","onClose","fail","startCompress","base64","compress","rate","resolve","_img","Image","src","onload","_canvas","document","createElement","w","this","width","h","height","setAttribute","getContext","drawImage","toDataURL","toBlob","blob","size","Promise","getUserMediaStream","videoNode","constrains","navigator","mediaDevices","getUserMedia","webkitGetUserMedia","mozGetUserMedia","audio","video","then","res","stream","reject","srcObject","onloadedmetadata","e","play","catch","error","console","log","name","message","withRouter","history","useState","videoHeight","setVideoHeight","fileList","setFileList","ref","useRef","useEffect","getElementById","rectangle","style","display","offsetHeight","current","setInterval","vh","vw","videoWidth","oh","ow","offsetWidth","getHeight","getWidth","getRealSize","getBoundingClientRect","left","top","context","window","scrollX","scrollY","err","clearInterval","__formatUploadFile2base64AndCompress","file","reader","FileReader","readAsDataURL","onloadend","result","handleImgFileBase64","url","files","updateUploadFiles","success","showSuccess","customUploadProps","onChange","event","target","accept","CustomUpload","className","styles","type","id","container","autoPlay","muted","playsInline","tips","PictureOutlined","Routes","useSelector","state","hasToken","path","exact","component","Photo","to","SET_HAS_TOKEN","auth","action","rootReducer","combineReducers","store","createStore","reducer","composeWithDevTools","applyMiddleware","thunk","App","ReactDOM","render","module","exports"],"mappings":"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","file":"static/js/main.fa9965ba.chunk.js","sourcesContent":["import { Toast } from 'antd-mobile';\n\nfunction __hide() {\n    Toast.hide();\n}\n\nfunction showToast(text = '', isError = true) {\n    __hide();\n    Toast.info(text || (isError && '出错了'), 2, null, false);\n}\n\nfunction hideToast() {\n    __hide();\n}\n\nfunction hideLoading() {\n    __hide();\n}\n\nfunction showLoading(text = 'Loading...') {\n    __hide();\n    Toast.loading(text, 0, () => {});\n}\n\nfunction showSuccess(config = {}) {\n    const { text = 'Success', mask = false, duration = 2, onClose = () => {} } = config;\n    Toast.success(text, duration, onClose, mask);\n}\n\nfunction showFail(config = {}) {\n    const { text = 'fail', mask = false, duration = 2, onClose = () => {} } = config;\n    Toast.fail(text, duration, onClose, mask);\n}\n\nexport { showToast, hideToast, hideLoading, showLoading, showSuccess, showFail };\n","function startCompress(base64) {\n    function compress(\n        base64, // 源图片\n        rate, // 缩放比例\n        resolve,\n    ) {\n        //处理缩放，转格式\n        var _img = new Image();\n        _img.src = base64;\n        _img.onload = function () {\n            var _canvas = document.createElement('canvas');\n            var w = this.width / rate;\n            var h = this.height / rate;\n            _canvas.setAttribute('width', w);\n            _canvas.setAttribute('height', h);\n            _canvas.getContext('2d').drawImage(this, 0, 0, w, h);\n            var base64 = _canvas.toDataURL('image/jpeg');\n            _canvas.toBlob(function (blob) {\n                // blob size单位为byte 1000byte = 1kb  1000kb = 1mb\n                if (blob.size > 750 * 1334) {\n                    //如果还大，继续压缩\n                    compress(base64, rate, resolve);\n                } else {\n                    resolve(base64);\n                }\n            }, 'image/jpeg');\n        };\n    }\n\n    return new Promise(resolve => {\n        compress(base64, 1.5, resolve);\n    });\n}\n\nexport { startCompress };\n","//访问用户媒体设备的兼容方法\nfunction getUserMedia(constrains) {\n    if (navigator.mediaDevices?.getUserMedia) {\n        //最新标准API\n        return navigator.mediaDevices.getUserMedia(constrains);\n    } else if (navigator.webkitGetUserMedia) {\n        //webkit内核浏览器\n        return navigator.webkitGetUserMedia(constrains);\n    } else if (navigator.mozGetUserMedia) {\n        //Firefox浏览器\n        return navigator.mozGetUserMedia(constrains);\n    } else if (navigator.getUserMedia) {\n        //旧版API\n        return navigator.getUserMedia(constrains);\n    }\n}\n\n//成功的回调函数\nfunction success(stream, video) {\n    return new Promise((resolve, reject) => {\n        video.srcObject = stream;\n\n        //播放视频\n        video.onloadedmetadata = function (e) {\n            video.play();\n            resolve();\n        };\n    });\n}\n\nfunction getUserMediaStream(videoNode) {\n    //调用用户媒体设备，访问摄像头\n    return getUserMedia({\n        audio: false,\n        // video: { facingMode: { exact: 'environment' } },\n        video: true,\n        // video: { facingMode: { exact: 'environment', width: 1280, height: 720 } },\n    })\n        .then(res => {\n            return success(res, videoNode);\n        })\n        .catch(error => {\n            console.log('访问用户媒体设备失败：', error.name, error.message);\n            return Promise.reject();\n        });\n}\n\nexport { getUserMediaStream };\n","import React, { useEffect, useRef, useState } from 'react';\nimport {\n    showLoading,\n    hideLoading,\n    showFail,\n    showSuccess,\n    hideToast,\n    showToast,\n} from '../../utils/toast';\nimport styles from './photo.module.scss';\nimport { PictureOutlined, LeftOutlined } from '@ant-design/icons';\nimport { startCompress } from '../../utils/compressBase64';\nimport { withRouter } from 'react-router';\nimport { getUserMediaStream } from '../../utils/getUserMediaStream';\n\nexport default withRouter(({ history }) => {\n    const [videoHeight, setVideoHeight] = useState(0);\n    const [fileList, setFileList] = useState([]);\n    const ref = useRef(null);\n\n    useEffect(() => {\n        const video = document.getElementById('video');\n        const rectangle = document.getElementById('capture-rectangle');\n        const container = document.getElementById('container');\n        const _canvas = document.createElement('canvas');\n        _canvas.style.display = 'block';\n\n        getUserMediaStream(video)\n            .then(() => {\n                setVideoHeight(video.offsetHeight);\n                startCapture();\n            })\n            .catch(err => {\n                showFail({\n                    text: '无法调起后置摄像头，请点击相册，手动上传身份证',\n                    duration: 6,\n                });\n            });\n\n        /**\n         * 获取video中对应的真实size\n         */\n        function getRealSize() {\n            const { videoHeight: vh, videoWidth: vw, offsetHeight: oh, offsetWidth: ow } = video;\n\n            return {\n                getHeight: height => {\n                    return (vh / oh) * height;\n                },\n                getWidth: width => {\n                    return (vw / ow) * width;\n                },\n            };\n        }\n\n        function isChildOf(child, parent) {\n            var parentNode;\n            if (child && parent) {\n                parentNode = child.parentNode;\n                while (parentNode) {\n                    if (parent === parentNode) {\n                        return true;\n                    }\n                    parentNode = parentNode.parentNode;\n                }\n            }\n            return false;\n        }\n\n        function startCapture() {\n            ref.current = setInterval(() => {\n                const { getHeight, getWidth } = getRealSize();\n                /** 获取框的位置 */\n                const { left, top, width, height } = rectangle.getBoundingClientRect();\n\n                /** 测试时预览 */\n                // if (isChildOf(_canvas, container)) {\n                //     container.removeChild(_canvas);\n                // }\n                // container.appendChild(_canvas);\n\n                const context = _canvas.getContext('2d');\n                _canvas.width = width;\n                _canvas.height = height;\n\n                context.drawImage(\n                    video,\n                    getWidth(left + window.scrollX),\n                    getHeight(top + window.scrollY),\n                    getWidth(width),\n                    getHeight(height),\n                    0,\n                    0,\n                    width,\n                    height,\n                );\n\n                const base64 = _canvas.toDataURL('image/jpeg');\n                // TODO 此处可以根据需要调用OCR识别接口\n            }, 200);\n        }\n\n        /** 防止内存泄露 */\n        return () => clearInterval(ref.current);\n    }, []);\n\n    /** 只支持1张图片 */\n    function updateUploadFiles(url) {\n        let files = [];\n        if (url) {\n            files = [{ url }];\n        }\n\n        setFileList(files);\n    }\n\n    const __formatUploadFile2base64AndCompress = file => {\n        const handleImgFileBase64 = file => {\n            return new Promise(resolve => {\n                const reader = new FileReader();\n                reader.readAsDataURL(file);\n\n                reader.onloadend = function () {\n                    resolve(reader.result);\n                };\n            });\n        };\n\n        showLoading();\n        handleImgFileBase64(file)\n            .then(res => {\n                if (file.size > 750 * 1334) {\n                    showLoading('图片压缩中...');\n                    return startCompress(res);\n                } else {\n                    return res;\n                }\n            })\n            .then(res => {\n                hideLoading();\n                updateUploadFiles();\n                // TODO 上传\n                showSuccess({\n                    text: '上传成功!',\n                });\n            })\n            .catch(err => {\n                console.error(err);\n                hideLoading();\n                showFail({\n                    text: '上传失败',\n                });\n            });\n    };\n\n    const onChangeFile = event => {\n        const files = event.target.files;\n        if (files?.[0]) {\n            __formatUploadFile2base64AndCompress(files[0]);\n        }\n    };\n\n    const customUploadProps = {\n        onChange: onChangeFile,\n        accept: 'image/jpeg,image/jpg,image/png',\n        files: fileList,\n    };\n\n    /**\n     * 从本地上传\n     */\n    const CustomUpload = customUploadProps => (\n        <input className={styles['input']} type=\"file\" {...customUploadProps} />\n    );\n\n    // const onClickBack = () => {\n    //     history.goBack();\n    // };\n\n    return (\n        <div id=\"container\" className={styles.container}>\n            {/* <LeftOutlined\n                    style={{ fontSize: '0.555rem' }}\n                    className={styles['back']}\n                    onClick={onClickBack}\n                /> */}\n            <video\n                id=\"video\"\n                autoPlay\n                muted\n                playsInline\n                style={{\n                    width: '100%',\n                }}\n            ></video>\n\n            <div className={styles['shadow-layer']} style={{ height: `${videoHeight}px` }}>\n                <div id=\"capture-rectangle\" className={styles['capture-rectangle']}></div>\n\n                <div className={styles['hold-tips']}>hold-tips</div>\n            </div>\n\n            <div className={styles.tips}>tips</div>\n\n            <div className={styles['gallery-container']}>\n                <CustomUpload {...customUploadProps} />\n                <PictureOutlined className={styles['icon']} />\n            </div>\n        </div>\n    );\n});\n","import React, { useEffect } from 'react';\nimport { Switch, Route, Redirect, BrowserRouter as Router } from 'react-router-dom';\nimport { useSelector } from 'react-redux';\nimport Photo from '../views/photo/photo';\n\nconst Routes = () => {\n    let hasToken = useSelector(state => state.hasToken);\n    return (\n        <Router>\n            <Switch>\n                <Route path=\"/photo\" exact={true} component={Photo}></Route>\n                <Redirect to=\"/photo\" />\n            </Switch>\n        </Router>\n    );\n};\n\nexport default Routes;\n","export const SET_HAS_TOKEN = 'SET_HAS_TOKEN';\n","import { SET_HAS_TOKEN } from '../../constants/constants';\n\nfunction auth(state = { hasToken: false }, action) {\n    const { type, hasToken } = action;\n\n    switch (type) {\n        case SET_HAS_TOKEN:\n            return {\n                ...state,\n                hasToken,\n            };\n        default:\n            return state;\n    }\n}\n\nexport default auth;\n","import { combineReducers } from 'redux';\n\nimport auth from './module/auth';\n\nconst rootReducer = combineReducers({\n    auth,\n});\n\nexport default rootReducer;\n","import { createStore, applyMiddleware } from 'redux';\nimport reducer from '../reducers/reducers';\nimport { composeWithDevTools } from 'redux-devtools-extension';\nimport thunk from 'redux-thunk';\n\nconst store = createStore(reducer, composeWithDevTools(applyMiddleware(thunk)));\n\nexport default store;\n","import React from 'react';\nimport Routes from './routes/routes';\nimport store from './store/store';\nimport { Provider, useSelector } from 'react-redux';\nimport 'lib-flexible';\nimport { BrowserRouter as Router, useLocation } from 'react-router-dom';\n\nimport 'antd-mobile/dist/antd-mobile.css'; // or 'antd-mobile/dist/antd-mobile.less'\nimport 'antd/dist/antd.css';\n\nconst App = () => {\n    return (\n        <Provider store={store}>\n            <Routes></Routes>\n        </Provider>\n    );\n};\n\nexport default App;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\n\nReactDOM.render(<App />, document.getElementById('root'));\n","// extracted by mini-css-extract-plugin\nmodule.exports = {\"container\":\"photo_container__rgeqZ\",\"back\":\"photo_back__3PQ-b\",\"shadow-layer\":\"photo_shadow-layer__NTgS5\",\"capture-rectangle\":\"photo_capture-rectangle__IvEkK\",\"hold-tips\":\"photo_hold-tips__3xMF8\",\"tips\":\"photo_tips__Pn9KU\",\"gallery-container\":\"photo_gallery-container__1AOx7\",\"input\":\"photo_input__3gWy0\",\"icon\":\"photo_icon__2cwh_\"};"],"sourceRoot":""}